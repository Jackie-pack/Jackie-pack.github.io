<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>汉字武斗场 Demo</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: 'SimHei', monospace;
    user-select: none;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
  }
  #game {
    margin-top: 10px;
    white-space: pre;
    font-size: 28px;
    line-height: 1;
    width: 600px;
    height: 320px;
    background: #222;
    border: 2px solid #555;
    padding: 12px;
    position: relative;
  }
  /* 角色颜色 */
  .player { color: #ff5555; text-shadow: 0 0 8px red; }
  .enemy { color: #aa00aa; }
  .boss { font-size: 40px; animation: glow 1s infinite alternate; user-select:none;}
  @keyframes glow {
    from {opacity: 1;}
    to {opacity: 0.6;}
  }
  /* 状态栏 */
  #status {
    margin-top: 10px;
    width: 600px;
    background: #222;
    border: 2px solid #555;
    padding: 8px 12px;
    font-size: 16px;
    display: flex; justify-content: space-between;
  }
  #status > div {
    min-width: 120px;
  }
  .hp, .energy {
    font-weight: bold;
  }
  .combo-list {
    max-height: 100px;
    overflow-y: auto;
    border-top: 1px solid #555;
    margin-top: 8px;
    padding-top: 4px;
    font-size: 14px;
  }
  .equipment {
    margin-top: 8px;
    font-size: 14px;
    color: #6cf;
  }
  /* 连招输入提示 */
  #inputBuffer {
    margin-top: 8px;
    font-size: 20px;
    color: #ffa;
    min-height: 30px;
  }
  /* 按键提示 */
  #hint {
    margin-top: 4px;
    font-size: 14px;
    color: #888;
  }
</style>
</head>
<body>

<h1>汉字武斗场 Demo</h1>
<div id="game" aria-label="游戏主界面"></div>

<div id="status">
  <div>
    <div>玩家: <span id="playerChar" class="player"></span></div>
    <div>生命值: <span id="playerHp" class="hp"></span></div>
    <div>能量值: <span id="playerEnergy" class="energy"></span></div>
  </div>
  <div>
    <div>BOSS: <span id="bossChar" class="boss"></span></div>
    <div>生命值: <span id="bossHp" class="hp"></span></div>
    <div>状态: <span id="bossState"></span></div>
  </div>
</div>

<div>
  <strong>当前连招列表 (按方向键/击气输入):</strong>
  <div class="combo-list" id="comboList"></div>
  <div class="equipment" id="equipmentList">装备: 无</div>
  <div id="inputBuffer"></div>
  <div id="hint">操作提示：用键盘输入“击”、“气”、“↑”、“↓”、“←”、“→”组成连招</div>
</div>

<script>
// —— 游戏数据结构定义 ——

const player = {
  char: "武",
  hp: 5,
  maxHp: 5,
  energy: 3,
  maxEnergy: 3,
  combos: ["击击击", "击气击", "↓↑气击"],
  equipment: [],
  level: 1,
  exp: 0
};

const boss = {
  charStates: ["狂", "枉"],
  currentStateIndex: 0,
  hp: 12,
  maxHp: 12,
  state: "狂", // 当前状态
  isDefending: false
};

const comboSystem = {
  unlocked: {
    "击击击": { damage: 3, energy: 0 },
    "击气击": { damage: 4, energy: 1 },
    "↓↑气击": { damage: 5, energy: 2 }
  },
  discoverable: {
    "气↓↑击气": { damage: 7, hint: "击败3个敌人后解锁" },
    "击击↓↑气": { damage: 8, hint: "装备'剑'后解锁" }
  }
};

// 装备示范（初始空）
player.equipment = ["剑"]; // 方便演示，预置装备“剑”

// —— DOM元素缓存 ——
const gameDiv = document.getElementById("game");
const playerCharSpan = document.getElementById("playerChar");
const playerHpSpan = document.getElementById("playerHp");
const playerEnergySpan = document.getElementById("playerEnergy");
const bossCharSpan = document.getElementById("bossChar");
const bossHpSpan = document.getElementById("bossHp");
const bossStateSpan = document.getElementById("bossState");
const comboListDiv = document.getElementById("comboList");
const equipmentListDiv = document.getElementById("equipmentList");
const inputBufferDiv = document.getElementById("inputBuffer");

// —— 输入管理 ——
const inputBuffer = [];
const COMBO_TIMEOUT = 1000; // 1秒内输入有效
let lastInputTime = 0;

const validInputs = new Set(["击", "气", "↑", "↓", "←", "→"]);

function addInput(key) {
  const now = Date.now();
  if(now - lastInputTime > COMBO_TIMEOUT){
    inputBuffer.length = 0; // 超时清空输入缓冲
  }
  if(validInputs.has(key)){
    inputBuffer.push(key);
    lastInputTime = now;
    updateInputBufferDisplay();
    checkCombos();
  }
}

function updateInputBufferDisplay(){
  inputBufferDiv.textContent = "输入缓冲：" + inputBuffer.join("");
}

// —— 连招判定 ——
function checkCombos(){
  const inputStr = inputBuffer.join("");
  for(const combo in comboSystem.unlocked){
    if(inputStr.endsWith(combo)){
      tryPerformCombo(combo);
      inputBuffer.length = 0; // 清空缓冲
      updateInputBufferDisplay();
      break;
    }
  }
}

// —— 战斗逻辑 ——

function tryPerformCombo(combo) {
  const comboData = comboSystem.unlocked[combo];
  if(!comboData) return;
  if(player.energy < comboData.energy){
    showMessage("能量不足，无法释放连招！");
    return;
  }
  player.energy -= comboData.energy;

  // 计算伤害
  let damage = comboData.damage;

  // 装备加成（示例）
  if(player.equipment.includes("剑")){
    damage = Math.floor(damage * 1.2);
  }

  // 伤害应用到BOSS
  if(boss.state === "枉" && boss.isDefending){
    // 反弹伤害，玩家受伤
    let reflectDamage = Math.floor(damage / 2);
    player.hp -= reflectDamage;
    showMessage(`BOSS反弹伤害！你受到 ${reflectDamage} 点伤害`);
  } else {
    boss.hp -= damage;
    showMessage(`你对BOSS造成 ${damage} 点伤害`);
  }

  // BOSS状态判定
  updateBossState();

  updateUI();
  checkEndConditions();
}

function updateBossState(){
  // BOSS“狂”和“枉”切换，每4秒切换一次，且切换时可被打双倍伤害
  const now = Date.now();
  if(!updateBossState.lastSwitch) updateBossState.lastSwitch = now;
  if(now - updateBossState.lastSwitch > 4000){
    updateBossState.lastSwitch = now;
    boss.currentStateIndex = (boss.currentStateIndex + 1) % boss.charStates.length;
    boss.state = boss.charStates[boss.currentStateIndex];
    boss.isDefending = (boss.state === "枉");
    showMessage(`BOSS状态切换为 "${boss.state}"${boss.isDefending ? "（防御反弹）" : ""}`);
  }
}

// —— UI更新 ——

function updateUI(){
  playerCharSpan.textContent = player.char;
  playerHpSpan.textContent = "❤".repeat(Math.max(player.hp,0)) + " ".repeat(player.maxHp - player.hp);
  playerEnergySpan.textContent = "✦".repeat(Math.max(player.energy,0)) + " ".repeat(player.maxEnergy - player.energy);
  bossCharSpan.textContent = boss.state;
  bossHpSpan.textContent = "❤".repeat(Math.max(boss.hp,0)) + " ".repeat(boss.maxHp - boss.hp);
  bossStateSpan.textContent = boss.isDefending ? "防御中" : "攻击中";

  // 连招列表显示
  comboListDiv.innerHTML = "";
  for(const c in comboSystem.unlocked){
    const d = comboSystem.unlocked[c];
    const div = document.createElement("div");
    div.textContent = `${c} → 伤害: ${d.damage}, 能量: ${d.energy}`;
    comboListDiv.appendChild(div);
  }

  // 装备显示
  if(player.equipment.length) {
    equipmentListDiv.textContent = "装备: " + player.equipment.join(", ");
  } else {
    equipmentListDiv.textContent = "装备: 无";
  }
}

// —— 消息显示 ——
let messageTimeout = null;
function showMessage(msg){
  if(messageTimeout) clearTimeout(messageTimeout);
  inputBufferDiv.textContent = msg;
  messageTimeout = setTimeout(updateInputBufferDisplay, 2000);
}

// —— 持续恢复能量（每秒） ——
setInterval(() => {
  if(player.energy < player.maxEnergy){
    player.energy++;
    updateUI();
  }
}, 1000);

// —— BOSS状态切换定时器 ——
setInterval(() => {
  updateBossState();
  updateUI();
}, 500);

// —— 胜负判断 ——
function checkEndConditions(){
  if(boss.hp <= 0){
    showMessage("恭喜！击败了BOSS“狂”！");
    resetBattle();
  } else if(player.hp <= 0){
    showMessage("你已阵亡，战斗结束！");
    resetBattle();
  }
}

function resetBattle(){
  // 重置状态
  player.hp = player.maxHp;
  player.energy = player.maxEnergy;
  boss.hp = boss.maxHp;
  boss.currentStateIndex = 0;
  boss.state = boss.charStates[0];
  boss.isDefending = false;
  updateUI();
}

// —— 键盘输入映射 ——

function mapKeyToAction(key){
  switch(key){
    case "j": return "击";
    case "k": return "气";
    case "ArrowUp": return "↑";
    case "ArrowDown": return "↓";
    case "ArrowLeft": return "←";
    case "ArrowRight": return "→";
    default: return null;
  }
}

window.addEventListener("keydown", e => {
  const input = mapKeyToAction(e.key);
  if(input){
    addInput(input);
    e.preventDefault();
  }
});

// —— 页面加载完成后初始化 ——

window.onload = () => {
  updateUI();
  updateInputBufferDisplay();
  showMessage("游戏准备完毕，输入连招：击/气 + 方向键 (用J/K及方向键代替)");
};
</script>
</body>
</html>
