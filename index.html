<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>汉字武斗场 - 汉字输入版Demo</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: 'SimHei', monospace;
    margin: 0; padding: 0;
    user-select: none;
    display: flex; flex-direction: column; align-items: center;
    height: 100vh;
  }
  #gameArea {
    position: relative;
    width: 600px;
    height: 320px;
    background: #222;
    border: 2px solid #555;
    margin-top: 10px;
    overflow: hidden;
    font-size: 40px;
    line-height: 1;
  }
  .entity {
    position: absolute;
    user-select: none;
    transition: left 0.2s, top 0.2s;
    font-weight: bold;
  }
  .player {
    color: #ff5555;
    text-shadow: 0 0 8px red;
  }
  .boss {
    color: #aa00aa;
    text-shadow: 0 0 12px purple;
  }
  .weapon {
    position: absolute;
    font-size: 28px;
    color: #66ccff;
    text-shadow: 0 0 8px #66ccff;
    user-select: none;
    pointer-events: none;
  }
  #statusBar {
    margin-top: 10px;
    width: 600px;
    background: #222;
    border: 2px solid #555;
    padding: 8px 12px;
    font-size: 18px;
    display: flex; justify-content: space-between;
  }
  #skillInputContainer {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 12px;
    border-radius: 8px;
    display: none;
  }
  #skillInput {
    font-size: 28px;
    padding: 6px 10px;
    width: 300px;
    border: none;
    outline: none;
    border-radius: 4px;
  }
  #skillInput::placeholder {
    color: #888;
  }
  #message {
    margin-top: 8px;
    height: 28px;
    color: #ffa;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>汉字武斗场 - 汉字输入版Demo</h1>

<div id="gameArea" aria-label="游戏战斗区域">
  <div id="player" class="entity player" style="left: 50px; top: 130px;">武</div>
  <div id="playerWeapon" class="weapon" style="left: 85px; top: 145px;">剑</div>
  <div id="boss" class="entity boss" style="left: 500px; top: 130px;">狂</div>
  <div id="bossWeapon" class="weapon" style="left: 465px; top: 145px;">剑</div>
</div>

<div id="statusBar">
  <div>玩家 血量: <span id="playerHp">5</span> 能量: <span id="playerEnergy">3</span></div>
  <div>BOSS 血量: <span id="bossHp">12</span></div>
</div>

<div id="skillInputContainer">
  <input type="text" id="skillInput" placeholder="请输入汉字连招，如：击击击、气气" autocomplete="off" />
</div>

<div id="message" aria-live="polite"></div>

<script>
(() => {
  const gameArea = document.getElementById("gameArea");
  const playerEl = document.getElementById("player");
  const bossEl = document.getElementById("boss");
  const playerWeaponEl = document.getElementById("playerWeapon");
  const bossWeaponEl = document.getElementById("bossWeapon");

  const playerHpEl = document.getElementById("playerHp");
  const playerEnergyEl = document.getElementById("playerEnergy");
  const bossHpEl = document.getElementById("bossHp");

  const skillInputContainer = document.getElementById("skillInputContainer");
  const skillInput = document.getElementById("skillInput");
  const messageEl = document.getElementById("message");

  // 游戏实体数据
  const player = {
    x: 50,
    y: 130,
    size: 40,
    hp: 5,
    maxHp: 5,
    energy: 3,
    maxEnergy: 3,
    speed: 10,
    combos: {
      "击击击": { damage: 3, energyCost: 0 },
      "气气": { damage: 4, energyCost: 1 },
      "击气击": { damage: 5, energyCost: 2 }
    },
    equipment: ["剑"]
  };

  const boss = {
    x: 500,
    y: 130,
    size: 40,
    hp: 12,
    maxHp: 12,
    speed: 3,
    isAttacking: false
  };

  // 更新实体位置UI
  function updatePositions(){
    playerEl.style.left = player.x + "px";
    playerEl.style.top = player.y + "px";
    // 武器在玩家右下方偏移
    playerWeaponEl.style.left = (player.x + 35) + "px";
    playerWeaponEl.style.top = (player.y + 15) + "px";

    bossEl.style.left = boss.x + "px";
    bossEl.style.top = boss.y + "px";
    // 武器在boss左下方偏移
    bossWeaponEl.style.left = (boss.x - 35) + "px";
    bossWeaponEl.style.top = (boss.y + 15) + "px";
  }

  // 更新状态栏
  function updateStatus(){
    playerHpEl.textContent = player.hp;
    playerEnergyEl.textContent = player.energy;
    bossHpEl.textContent = boss.hp;
  }

  // 显示提示信息
  function showMessage(msg, duration=2000){
    messageEl.textContent = msg;
    if(duration > 0){
      clearTimeout(showMessage.timeoutId);
      showMessage.timeoutId = setTimeout(() => {
        messageEl.textContent = "";
      }, duration);
    }
  }

  // 玩家移动限制，边界判定
  function clampPosition(){
    player.x = Math.min(Math.max(player.x, 0), gameArea.clientWidth - player.size);
    player.y = Math.min(Math.max(player.y, 0), gameArea.clientHeight - player.size);
    boss.x = Math.min(Math.max(boss.x, 0), gameArea.clientWidth - boss.size);
    boss.y = Math.min(Math.max(boss.y, 0), gameArea.clientHeight - boss.size);
  }

  // 简单碰撞检测
  function isColliding(a, b){
    return !(
      a.x + a.size < b.x ||
      a.x > b.x + b.size ||
      a.y + a.size < b.y ||
      a.y > b.y + b.size
    );
  }

  // BOSS追踪玩家（简单向玩家方向移动）
  function bossAI(){
    if(boss.isAttacking) return; // 攻击中暂不移动

    if(boss.x < player.x) boss.x += boss.speed;
    else if(boss.x > player.x) boss.x -= boss.speed;

    if(boss.y < player.y) boss.y += boss.speed;
    else if(boss.y > player.y) boss.y -= boss.speed;

    clampPosition();
    updatePositions();
  }

  // BOSS攻击玩家
  function bossAttack(){
    if(isColliding(player, boss)){
      if(!boss.isAttacking){
        boss.isAttacking = true;
        player.hp -= 1;
        updateStatus();
        showMessage("BOSS 攻击！你受到 1 点伤害", 1500);
        if(player.hp <= 0){
          showMessage("你被击败了！游戏结束", 0);
          gameOver();
          return;
        }
        setTimeout(() => {
          boss.isAttacking = false;
        }, 1000);
      }
    }
  }

  // 游戏结束处理
  function gameOver(){
    skillInputContainer.style.display = "none";
    clearInterval(gameLoopInterval);
    window.removeEventListener("keydown", keydownHandler);
    window.removeEventListener("keyup", keyupHandler);
  }

  // 玩家技能释放，输入的是汉字连招字符串
  function tryUseSkill(inputStr){
    const skill = player.combos[inputStr];
    if(!skill){
      showMessage("无效连招！");
      return false;
    }
    if(player.energy < skill.energyCost){
      showMessage("能量不足！");
      return false;
    }
    player.energy -= skill.energyCost;

    // 计算伤害，装备“剑”加成20%
    let damage = skill.damage;
    if(player.equipment.includes("剑")){
      damage = Math.floor(damage * 1.2);
    }
    boss.hp -= damage;
    updateStatus();
    showMessage(`释放连招"${inputStr}"，对BOSS造成${damage}点伤害！`, 2500);

    if(boss.hp <= 0){
      showMessage("恭喜你击败了BOSS！", 0);
      gameOver();
    }
    return true;
  }

  // 玩家移动控制
  const keysDown = new Set();
  let canMove = true;
  function movePlayer(){
    if(!canMove) return;
    if(keysDown.has("ArrowUp")) player.y -= player.speed;
    if(keysDown.has("ArrowDown")) player.y += player.speed;
    if(keysDown.has("ArrowLeft")) player.x -= player.speed;
    if(keysDown.has("ArrowRight")) player.x += player.speed;
    clampPosition();
  }

  // 主循环
  function gameLoop(){
    movePlayer();
    bossAI();
    bossAttack();
    updatePositions();
  }

  // 监听键盘事件
  function keydownHandler(e){
    if(skillInputContainer.style.display === "block"){
      // 技能输入框激活时，拦截除回车外的按键
      if(e.key === "Enter"){
        const val = skillInput.value.trim();
        if(val.length > 0){
          tryUseSkill(val);
          skillInput.value = "";
          skillInputContainer.style.display = "none";
          canMove = true;
        } else {
          skillInputContainer.style.display = "none";
          canMove = true;
          showMessage("取消技能输入");
        }
        e.preventDefault();
      }
      return; // 其他按键忽略
    }
    // 非输入框时，监听移动键和E键
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
      if(canMove) keysDown.add(e.key);
      e.preventDefault();
    }
    if((e.key === "e" || e.key === "E") && !skillInputContainer.style.display.includes("block")){
      skillInputContainer.style.display = "block";
      skillInput.focus();
      canMove = false; // 禁止走位
      e.preventDefault();
    }
  }
  function keyupHandler(e){
    keysDown.delete(e.key);
  }

  window.addEventListener("keydown", keydownHandler);
  window.addEventListener("keyup", keyupHandler);

  // 启动游戏循环
  const FPS = 30;
  const gameLoopInterval = setInterval(gameLoop, 1000 / FPS);

  // 初始化UI
  updatePositions();
  updateStatus();
  showMessage('按方向键移动，按"E"键打开技能输入框，输入汉字连招');
})();
</script>

</body>
</html>
